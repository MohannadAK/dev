#!/usr/bin/env bash

# Script to find all Git repositories in the current directory (or subdirectories)
# and perform git add, commit, and push operations.

# Exit on any error
set -e

# Get the current working directory
CURRENT_DIR=$(pwd)

# Function to process a single Git repository
process_repo() {
    local repo_dir="$1"
    echo "Processing repository: $repo_dir"

    # Change to the repository directory
    pushd "$repo_dir" > /dev/null

    # Check if there are changes to commit
    if git status --porcelain | grep -q .; then
        # Add all changes
        git add .

        # Commit changes with a default message
        git commit -m 'automated dev commit' || {
            echo "No changes to commit in $repo_dir"
        }

        # Push to the remote repository
        git push || {
            echo "Failed to push in $repo_dir. Check remote configuration or network."
        }
    else
        echo "No changes to commit in $repo_dir"
    fi

    # Return to the original directory
    popd > /dev/null
}

# Find all directories containing a .git folder
echo "Searching for Git repositories in $CURRENT_DIR..."
find "$CURRENT_DIR" -type d -name ".git" | while read -r git_dir; do
    # Get the parent directory of .git (the actual repository root)
    repo_dir=$(dirname "$git_dir")

    # Process the repository
    process_repo "$repo_dir"
done

echo "Finished processing all Git repositories."
